{"version":3,"sources":["../../src/middleware/rateLimit.js"],"names":["require","pRateLimit","assign","module","exports","rateLimit","options","rate","Error","limit","onReturn","channels","request","response","publish","ctx","Promise","resolve","reject","error","subscribe","catch","err","name","message","maxDelayError"],"mappings":";;eAAqBA,OAAO,CAAC,sBAAD,C;IAArBC,U,YAAAA,U;;AACP,IAAMC,MAAM,GAAGF,OAAO,CAAC,eAAD,CAAtB;;AAEAG,MAAM,CAACC,OAAP,GAAiB,SAASC,SAAT,GAAiC;AAAA,MAAdC,OAAc,uEAAJ,EAAI;;AAChD,MAAI,CAACA,OAAO,CAACC,IAAT,IAAiBD,OAAO,CAACC,IAAR,GAAe,CAApC,EAAuC;AACrC,UAAM,IAAIC,KAAJ,0EAAN;AACD;;AAED,MAAMC,KAAK,GAAGR,UAAU,CAACK,OAAD,CAAxB;;AAEA,WAASI,QAAT,CAAkBC,QAAlB,EAA4B;AAC1B,QAAI,CAACA,QAAQ,CAACC,OAAV,IAAqB,CAACD,QAAQ,CAACE,QAAnC,EAA6C;AAC3C,YAAM,IAAIL,KAAJ,CAAU,4EAAV,CAAN;AACD;;AAED,QAAMM,OAAO,GAAG,SAAVA,OAAU,CAACC,GAAD,EAAS;AACvB,aAAON,KAAK,CACV;AAAA,eACE,IAAIO,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AAC/BP,UAAAA,QAAQ,CAACQ,KAAT,CAAeC,SAAf,CAAyBF,MAAzB;AACAP,UAAAA,QAAQ,CAACE,QAAT,CAAkBO,SAAlB,CAA4BH,OAA5B;AACAN,UAAAA,QAAQ,CAACC,OAAT,CAAiBE,OAAjB,CAAyBC,GAAzB;AACD,SAJD,CADF;AAAA,OADU,CAAL,CAOLM,KAPK,CAOC,UAACC,GAAD,EAAS;AACf,YAAIA,GAAG,CAACC,IAAJ,KAAa,uBAAjB,EAA0C;AACxCD,UAAAA,GAAG,CAACE,OAAJ,GAAclB,OAAO,CAACmB,aAAR,IAAyB,8BAAvC;AACD;;AACDd,QAAAA,QAAQ,CAACQ,KAAT,CAAeL,OAAf,CAAuBQ,GAAvB;AACD,OAZM,CAAP;AAaD,KAdD;;AAgBA,QAAMV,OAAO,GAAG;AAACE,MAAAA,OAAO,EAAPA,OAAD;AAAUM,MAAAA,SAAS,EAAET,QAAQ,CAACC,OAAT,CAAiBE;AAAtC,KAAhB;AACA,WAAOZ,MAAM,CAAC,EAAD,EAAKS,QAAL,EAAe;AAACC,MAAAA,OAAO,EAAPA;AAAD,KAAf,CAAb;AACD;;AAED,SAAO;AAACF,IAAAA,QAAQ,EAARA;AAAD,GAAP;AACD,CAjCD","sourcesContent":["const {pRateLimit} = require('@rexxars/p-ratelimit')\nconst assign = require('object-assign')\n\nmodule.exports = function rateLimit(options = {}) {\n  if (!options.rate || options.rate < 1) {\n    throw new Error(`'rate' options must be passed to rateLimit middleware, and must be > 0`)\n  }\n\n  const limit = pRateLimit(options)\n\n  function onReturn(channels) {\n    if (!channels.request || !channels.response) {\n      throw new Error('Rate limit middleware must be called before promise/observable middlewares')\n    }\n\n    const publish = (ctx) => {\n      return limit(\n        () =>\n          new Promise((resolve, reject) => {\n            channels.error.subscribe(reject)\n            channels.response.subscribe(resolve)\n            channels.request.publish(ctx)\n          })\n      ).catch((err) => {\n        if (err.name === 'RateLimitTimeoutError') {\n          err.message = options.maxDelayError || 'Rate limit max delay reached'\n        }\n        channels.error.publish(err)\n      })\n    }\n\n    const request = {publish, subscribe: channels.request.publish}\n    return assign({}, channels, {request})\n  }\n\n  return {onReturn}\n}\n"],"file":"rateLimit.js"}