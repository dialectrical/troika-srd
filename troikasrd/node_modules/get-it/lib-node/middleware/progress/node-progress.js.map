{"version":3,"sources":["../../../src/middleware/progress/node-progress.js"],"names":["progressStream","require","normalizer","stage","prog","percent","percentage","total","length","loaded","transferred","lengthComputable","module","exports","onHeaders","response","evt","progress","time","normalize","contentLength","headers","Number","isNaN","setLength","on","context","channels","publish","pipe","onRequest"],"mappings":";;AAAA,MAAMA,iBAAiBC,QAAQ,iBAAR,CAAvB;;AAEA,SAASC,UAAT,CAAoBC,KAApB,EAA2B;AACzB,SAAOC,SAAS;AACdD,SADc;AAEdE,aAASD,KAAKE,UAFA;AAGdC,WAAOH,KAAKI,MAHE;AAIdC,YAAQL,KAAKM,WAJC;AAKdC,sBAAkB,EAAEP,KAAKI,MAAL,KAAgB,CAAhB,IAAqBJ,KAAKE,UAAL,KAAoB,CAA3C;AALJ,GAAT,CAAP;AAOD;;AAEDM,OAAOC,OAAP,GAAiB,OAAO;AACtBC,aAAW,CAACC,QAAD,EAAWC,GAAX,KAAmB;AAC5B,UAAMC,WAAWjB,eAAe,EAACkB,MAAM,EAAP,EAAf,CAAjB;AACA,UAAMC,YAAYjB,WAAW,UAAX,CAAlB;;AAEA;AACA;AACA,UAAMkB,gBAAgBL,SAASM,OAAT,CAAiB,gBAAjB,CAAtB;AACA,UAAMb,SAASY,iBAAiBE,OAAOF,aAAP,CAAhC;AACA,QAAI,CAACG,MAAMf,MAAN,CAAD,IAAkBA,SAAS,CAA/B,EAAkC;AAChCS,eAASO,SAAT,CAAmBhB,MAAnB;AACD;;AAEDS,aAASQ,EAAT,CAAY,UAAZ,EAAwBrB,QAAQY,IAAIU,OAAJ,CAAYC,QAAZ,CAAqBV,QAArB,CAA8BW,OAA9B,CAAsCT,UAAUf,IAAV,CAAtC,CAAhC;AACA,WAAOW,SAASc,IAAT,CAAcZ,QAAd,CAAP;AACD,GAfqB;;AAiBtBa,aAAWd,OAAO;AAChB,QAAI,CAACA,IAAIC,QAAT,EAAmB;AACjB;AACD;;AAED,UAAME,YAAYjB,WAAW,QAAX,CAAlB;AACAc,QAAIC,QAAJ,CAAaQ,EAAb,CAAgB,UAAhB,EAA4BrB,QAAQY,IAAIU,OAAJ,CAAYC,QAAZ,CAAqBV,QAArB,CAA8BW,OAA9B,CAAsCT,UAAUf,IAAV,CAAtC,CAApC;AACD;AAxBqB,CAAP,CAAjB","file":"node-progress.js","sourcesContent":["const progressStream = require('progress-stream')\n\nfunction normalizer(stage) {\n  return prog => ({\n    stage,\n    percent: prog.percentage,\n    total: prog.length,\n    loaded: prog.transferred,\n    lengthComputable: !(prog.length === 0 && prog.percentage === 0)\n  })\n}\n\nmodule.exports = () => ({\n  onHeaders: (response, evt) => {\n    const progress = progressStream({time: 16})\n    const normalize = normalizer('download')\n\n    // This is supposed to be handled automatically, but it has a bug,\n    // see https://github.com/freeall/progress-stream/pull/22\n    const contentLength = response.headers['content-length']\n    const length = contentLength && Number(contentLength)\n    if (!isNaN(length) && length > 0) {\n      progress.setLength(length)\n    }\n\n    progress.on('progress', prog => evt.context.channels.progress.publish(normalize(prog)))\n    return response.pipe(progress)\n  },\n\n  onRequest: evt => {\n    if (!evt.progress) {\n      return\n    }\n\n    const normalize = normalizer('upload')\n    evt.progress.on('progress', prog => evt.context.channels.progress.publish(normalize(prog)))\n  }\n})\n"]}