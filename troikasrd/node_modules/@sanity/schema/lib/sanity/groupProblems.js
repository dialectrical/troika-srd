"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getTypeProblems = getTypeProblems;
exports.default = groupProblems;

var _get2 = _interopRequireDefault(require("lodash/get"));

var _flatten2 = _interopRequireDefault(require("lodash/flatten"));

var _createValidationResult = require("./validation/createValidationResult");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function createTypeWithMembersProblemsAccessor(memberPropertyName) {
  var getMembers = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : type => (0, _get2.default)(type, memberPropertyName);
  return function getProblems(type, parentPath) {
    var currentPath = [...parentPath, {
      kind: 'type',
      type: type.type,
      name: type.name
    }];
    var members = getMembers(type) || [];
    var memberProblems = Array.isArray(members) ? members.map(memberType => {
      var memberPath = [...currentPath, {
        kind: 'property',
        name: memberPropertyName
      }];
      return getTypeProblems(memberType, memberPath);
    }) : [{
      path: currentPath,
      problems: [(0, _createValidationResult.error)("Member declaration (".concat(memberPropertyName, ") is not an array"))]
    }];
    return [{
      path: currentPath,
      problems: type._problems || []
    }, ...(0, _flatten2.default)(memberProblems)];
  };
}

var arrify = val => Array.isArray(val) ? val : typeof val === 'undefined' && [] || [val];

var getObjectProblems = createTypeWithMembersProblemsAccessor('fields');
var getImageProblems = createTypeWithMembersProblemsAccessor('fields');
var getFileProblems = createTypeWithMembersProblemsAccessor('fields');
var getArrayProblems = createTypeWithMembersProblemsAccessor('of');
var getReferenceProblems = createTypeWithMembersProblemsAccessor('to', type => arrify(type.to));
var getBlockAnnotationProblems = createTypeWithMembersProblemsAccessor('marks.annotations');
var getBlockMemberProblems = createTypeWithMembersProblemsAccessor('of');

var getBlockProblems = (type, problems) => [...getBlockAnnotationProblems(type, problems), ...getBlockMemberProblems(type, problems)];

function getDefaultProblems(type) {
  var path = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  return [{
    path: [...path, {
      kind: 'type',
      type: type.type,
      name: type.name
    }],
    problems: type._problems || []
  }];
}

function getTypeProblems(type) {
  var path = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];

  switch (type.type) {
    case 'object':
      {
        return getObjectProblems(type, path);
      }

    case 'document':
      {
        return getObjectProblems(type, path);
      }

    case 'array':
      {
        return getArrayProblems(type, path);
      }

    case 'reference':
      {
        return getReferenceProblems(type, path);
      }

    case 'block':
      {
        return getBlockProblems(type, path);
      }

    case 'image':
      {
        return getImageProblems(type, path);
      }

    case 'file':
      {
        return getFileProblems(type, path);
      }

    default:
      {
        return getDefaultProblems(type, path);
      }
  }
}

function groupProblems(types) {
  return (0, _flatten2.default)(types.map(type => getTypeProblems(type))).filter(type => type.problems.length > 0);
}