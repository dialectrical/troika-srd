"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireDefault(require("react"));

var _logos = require("@sanity/logos");

var _ui = require("@sanity/ui");

var _rxjs = require("rxjs");

var _operators = require("rxjs/operators");

var _CookieTest = _interopRequireDefault(require("./CookieTest"));

var _ErrorDialog = _interopRequireDefault(require("./ErrorDialog"));

var _UnauthorizedUser = _interopRequireDefault(require("./UnauthorizedUser"));

var _versionedClient = require("./versionedClient");

var _legacyParts = require("./legacyParts");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var isProjectLogin = _versionedClient.versionedClient.config().useProjectHostname;

var projectId = isProjectLogin && _versionedClient.versionedClient.config().projectId ? _versionedClient.versionedClient.config().projectId : null;

class LoginWrapper extends _react.default.PureComponent {
  constructor(props) {
    super(props);

    _defineProperty(this, "state", {
      isLoading: true,
      user: null,
      error: null
    });

    _defineProperty(this, "userSubscription", null);

    _defineProperty(this, "handleRetry", () => {
      this.setState({
        error: null,
        isLoading: true
      });

      _legacyParts.userStore.actions.retry();
    });

    var sync = true;
    this.userSubscription = _legacyParts.userStore.me.pipe((0, _operators.map)(currentUser => ({
      user: currentUser,
      isLoading: false
    })), (0, _operators.catchError)(error => (0, _rxjs.of)({
      user: null,
      error,
      isLoading: false
    }))).subscribe({
      next: userState => {
        // Because observables _can_ be synchronous, it's not safe to call `setState` as it is a noop
        // We must therefore explicitly check whether or not we were call synchronously
        if (sync) {
          // eslint-disable-next-line react/no-direct-mutation-state
          this.state = _objectSpread(_objectSpread({}, this.state), userState);
        } else {
          this.setState(userState);
        }
      }
    });
    sync = false;
  }

  componentWillUnmount() {
    if (this.userSubscription) {
      this.userSubscription.unsubscribe();
    }
  }

  render() {
    var _this$state = this.state,
        error = _this$state.error,
        user = _this$state.user,
        isLoading = _this$state.isLoading;
    var _this$props = this.props,
        children = _this$props.children,
        LoadingScreen = _this$props.LoadingScreen,
        sanityLogo = _this$props.sanityLogo,
        SanityLogo = _this$props.SanityLogo;

    if (sanityLogo) {
      var warning = 'sanityLogo is a deprecated property on LoginWrapper. Pass a React component to the SanityLogo property instead.';
      console.warn(warning); // eslint-disable-line no-console
    }

    if (isLoading) {
      return typeof LoadingScreen === 'function' ? /*#__PURE__*/_react.default.createElement(LoadingScreen, {
        center: true,
        fullscreen: true
      }) : LoadingScreen;
    }

    if (error) {
      return /*#__PURE__*/_react.default.createElement(_ErrorDialog.default, {
        onRetry: this.handleRetry,
        error: error
      });
    }

    if (!user) {
      return /*#__PURE__*/_react.default.createElement(_CookieTest.default, this.props, /*#__PURE__*/_react.default.createElement(_legacyParts.LoginDialog, {
        title: this.props.title,
        description: this.props.description,
        SanityLogo: SanityLogo,
        projectId: projectId
      }));
    }

    if (projectId && !user.role) {
      return /*#__PURE__*/_react.default.createElement(_UnauthorizedUser.default, {
        user: user
      });
    }

    return typeof children === 'function' ? children(user) : children;
  }

}

exports.default = LoginWrapper;

_defineProperty(LoginWrapper, "propTypes", {
  children: _propTypes.default.oneOfType([_propTypes.default.node, _propTypes.default.func]).isRequired,
  title: _propTypes.default.node,
  description: _propTypes.default.node,
  sanityLogo: _propTypes.default.node,
  SanityLogo: _propTypes.default.func,
  LoadingScreen: _propTypes.default.oneOfType([_propTypes.default.node, _propTypes.default.func])
});

_defineProperty(LoginWrapper, "defaultProps", {
  title: 'Choose a login provider',
  description: null,
  sanityLogo: null,
  SanityLogo: _logos.SanityLogo,
  LoadingScreen: /*#__PURE__*/_react.default.createElement(_ui.Container, {
    padding: 4,
    height: "fill"
  }, /*#__PURE__*/_react.default.createElement(_ui.Flex, {
    justify: "center",
    align: "center",
    height: "fill"
  }, /*#__PURE__*/_react.default.createElement(_ui.Spinner, null)))
});