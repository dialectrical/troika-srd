import { createClient } from './createClient';
import { createConnect } from './createConnect';
import { timeoutFirstWith } from './operators';
import { shareReplay, takeUntil } from 'rxjs/operators';
import { throwError, fromEvent } from 'rxjs';
const connect = createConnect((url, protocols) => new window.WebSocket(url, protocols));
const id = (arg) => arg;
export function fromUrl(url, options = {}) {
    return createClient(connect(url).pipe(options.timeout
        ? timeoutFirstWith(options.timeout, throwError(new Error(`Timeout after ${options.timeout} while establishing WebSockets connection`)))
        : id, shareReplay({ refCount: true }), takeUntil(fromEvent(window, 'beforeunload'))));
}
export function fromSanityClient(client) {
    const { dataset } = client.config();
    return fromUrl(client.getUrl(`/socket/${dataset}`).replace(/^http/, 'ws'));
}
